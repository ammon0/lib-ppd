<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>MPL: src/gen-x86.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MPL
   </div>
   <div id="projectbrief">A retargetable back-end of a machine language translator.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">gen-x86.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>generates x86 assembler code from the portable program data.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;x86.hpp&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:abea8e8696643db94b3783f0dd9b69069"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="abea8e8696643db94b3783f0dd9b69069"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>reftoval</b> (std::string &amp;s)</td></tr>
<tr class="separator:abea8e8696643db94b3783f0dd9b69069"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7fcaa90839242fff150141d600976814"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a7fcaa90839242fff150141d600976814"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>op_size</b> (std::string &amp;s, lbl_pt var)</td></tr>
<tr class="separator:a7fcaa90839242fff150141d600976814"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac14c45f1790c41377de3bdfd5f71a181"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ac14c45f1790c41377de3bdfd5f71a181"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>Resolve</b> (std::string &amp;s, lbl_pt lbl)</td></tr>
<tr class="separator:ac14c45f1790c41377de3bdfd5f71a181"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab82b7ef8d9c0bbfd2374b65b4e63589a"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ab82b7ef8d9c0bbfd2374b65b4e63589a"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>Stash</b> (reg_t reg)</td></tr>
<tr class="separator:ab82b7ef8d9c0bbfd2374b65b4e63589a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afb48b44a39dd34432de37bb2ec350190"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="afb48b44a39dd34432de37bb2ec350190"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gen-x86_8cpp.html#afb48b44a39dd34432de37bb2ec350190">Load</a> (reg_t target, lbl_pt source)</td></tr>
<tr class="memdesc:afb48b44a39dd34432de37bb2ec350190"><td class="mdescLeft">&#160;</td><td class="mdescRight"><a class="el" href="gen-x86_8cpp.html#afb48b44a39dd34432de37bb2ec350190" title="Load(reg_t reg, lbl_pt lbl) loads a label value into a register first clearing the register...">Load(reg_t reg, lbl_pt lbl)</a> loads a label value into a register first clearing the register. <br /></td></tr>
<tr class="separator:afb48b44a39dd34432de37bb2ec350190"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a74b4d438a9c98b175637f407f1033c76"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a74b4d438a9c98b175637f407f1033c76"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>ass</b> (lbl_pt dest, lbl_pt source)</td></tr>
<tr class="separator:a74b4d438a9c98b175637f407f1033c76"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a59ac7c2b947db2f06513e80602d7cc32"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a59ac7c2b947db2f06513e80602d7cc32"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>binary_l</b> (inst_code op, lbl_pt dest, lbl_pt source)</td></tr>
<tr class="separator:a59ac7c2b947db2f06513e80602d7cc32"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a92a8a835be3d294d98e07fecf949755e"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a92a8a835be3d294d98e07fecf949755e"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>binary_r</b> (inst_code op, lbl_pt dest, lbl_pt left, lbl_pt right)</td></tr>
<tr class="separator:a92a8a835be3d294d98e07fecf949755e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abdb3c59dd2fe6f052b60a60316b31328"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="abdb3c59dd2fe6f052b60a60316b31328"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>call</b> (lbl_pt result, lbl_pt proc)</td></tr>
<tr class="separator:abdb3c59dd2fe6f052b60a60316b31328"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af4bf465296ca3caa511c8bae2ae7e3ff"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af4bf465296ca3caa511c8bae2ae7e3ff"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>cpy</b> (lbl_pt dest, lbl_pt source, lbl_pt cnt)</td></tr>
<tr class="separator:af4bf465296ca3caa511c8bae2ae7e3ff"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a74796a4764d732fa69548fb1fab53454"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a74796a4764d732fa69548fb1fab53454"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>dec</b> (lbl_pt target)</td></tr>
<tr class="separator:a74796a4764d732fa69548fb1fab53454"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaa48781520319855b128c2a1fba5de18"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="aaa48781520319855b128c2a1fba5de18"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>div</b> (inst_code op, lbl_pt dest, lbl_pt dividend, lbl_pt divisor)</td></tr>
<tr class="separator:aaa48781520319855b128c2a1fba5de18"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1f502ae38c98b081c627ed4ad3c8e383"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a1f502ae38c98b081c627ed4ad3c8e383"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>inc</b> (lbl_pt target)</td></tr>
<tr class="separator:a1f502ae38c98b081c627ed4ad3c8e383"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a210a21c918f48abafda928fa740296f3"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a210a21c918f48abafda928fa740296f3"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>ret</b> (lbl_pt val)</td></tr>
<tr class="separator:a210a21c918f48abafda928fa740296f3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4341d81ed3e20f1517045270f56b171d"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a4341d81ed3e20f1517045270f56b171d"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>shift_l</b> (inst_code op, lbl_pt dest, lbl_pt count)</td></tr>
<tr class="separator:a4341d81ed3e20f1517045270f56b171d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a77e348c8524b856defc7830786fad3df"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a77e348c8524b856defc7830786fad3df"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>shift_r</b> (inst_code op, lbl_pt dest, lbl_pt source, lbl_pt count)</td></tr>
<tr class="separator:a77e348c8524b856defc7830786fad3df"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae50feaa7782ae0324c603adcb8112c79"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="ae50feaa7782ae0324c603adcb8112c79"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>sz</b> (lbl_pt size, lbl_pt object)</td></tr>
<tr class="separator:ae50feaa7782ae0324c603adcb8112c79"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afbc3b4bb1c47f2befd0419a57406f36f"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="afbc3b4bb1c47f2befd0419a57406f36f"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>Gen_inst</b> (inst_pt inst)</td></tr>
<tr class="separator:afbc3b4bb1c47f2befd0419a57406f36f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1a07fd49ec2cb3824856c2df246ff019"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a1a07fd49ec2cb3824856c2df246ff019"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gen-x86_8cpp.html#a1a07fd49ec2cb3824856c2df246ff019">Gen_blk</a> (blk_pt blk)</td></tr>
<tr class="memdesc:a1a07fd49ec2cb3824856c2df246ff019"><td class="mdescLeft">&#160;</td><td class="mdescRight">Generate code for a single basic block. <br /></td></tr>
<tr class="separator:a1a07fd49ec2cb3824856c2df246ff019"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a574436c457374def1ed649e4a0ec287b"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gen-x86_8cpp.html#a574436c457374def1ed649e4a0ec287b">Gen_routine</a> (lbl_pt lbl, Routine *routine)</td></tr>
<tr class="memdesc:a574436c457374def1ed649e4a0ec287b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Creates and tears down the activation record of a procedure.  <a href="#a574436c457374def1ed649e4a0ec287b">More...</a><br /></td></tr>
<tr class="separator:a574436c457374def1ed649e4a0ec287b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a53ff4c8ab223cf593c0d17d5935b88a2"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a53ff4c8ab223cf593c0d17d5935b88a2"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="gen-x86_8cpp.html#a53ff4c8ab223cf593c0d17d5935b88a2">x86</a> (FILE *out_fd, PPD *prog, x86_mode_t proccessor_mode)</td></tr>
<tr class="memdesc:a53ff4c8ab223cf593c0d17d5935b88a2"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function creates assembler code by making multiple passes through the PPD object list. <br /></td></tr>
<tr class="separator:a53ff4c8ab223cf593c0d17d5935b88a2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a91296bfd4f4622694129eaa974281c8e"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a91296bfd4f4622694129eaa974281c8e"></a>
static <a class="el" href="classReg__man.html">Reg_man</a>&#160;</td><td class="memItemRight" valign="bottom"><b>reg_d</b></td></tr>
<tr class="separator:a91296bfd4f4622694129eaa974281c8e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>generates x86 assembler code from the portable program data. </p>
<h2>Code Generation</h2>
<p>x86 instructions typically replace the left operand with the result. Since results will always be temporaries, and temporaries are only ever used once. In this generator we will try to make the left operand and the result always be the accumulator. This creates a need for an optimizer that algebraically rearranges things.</p>
<h2>Register Allocation</h2>
<p>There is a problem if a temp variable is not immediately used. All temps are produced in the accumulator. If at any point in code generation we find that the contents of the accumulator is temp and not being used in the current instruction then it will have to be stored somewhere. Another register would be ideal.</p>
<h2>Parameters</h2>
<p>When the actual parameter structure is allocated its offset from BP is noted. Registers can still spill beyond it as long as they are removed before the call.</p>
<h2>Activation Record</h2>
<pre>
  Activation Record   Instructions
|___________________|
| Formal parameters |
|___________________|
|         IP        | CALL / RET
|___________________|
|         BP        | ENTER / LEAVE
|___________________| &lt;-BP
|       Autos       |
|___________________|
| Spilled Registers |
|___________________|
| Actual Parameters |
|_03_|_02_|_01_|_00_| &lt;-SP
</pre><p>SP is always pointing to the top item on the stack, so PUSH=DEC,MOV POP=MOV,INC</p>
<p>BP is always pointing to the stored BP of the caller</p>
<p>Formal parameters are accessed as [BP+2*stack_width+label]</p>
<p>Stack variables are accessed as [BP-frame_size+label]</p>
<p>Spilled registers are accessed as [BP-frame_size-stack_width*offset]</p>
<h2>Addressing</h2>
<h3>Effective Address</h3>
<p>Effective Address = reg + (Scale x reg) + immediate</p><ul>
<li>Scale: A positive value of 1, 2, 4, or 8.</li>
<li>Displacement: An 8-bit, 16-bit, or 32-bit two’s-complement value encoded as part of the instruction.</li>
</ul>
<h3>Logical Addresses</h3>
<p>Logical Address = Segment Selector : Effective Address A logical address is a reference into a segmented-address space. It is comprised of the segment selector and the effective address.</p>
<h3>Linear Address</h3>
<p>Linear Address = Segment Base Address + Effective Address In the flat memory model the segment base address is always 0 and linear addresses are equivalent to effective addresses.</p>
<h3>Physical Address</h3>
<p>physical addresses are translated from linear addresses through paging. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a574436c457374def1ed649e4a0ec287b"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void Gen_routine </td>
          <td>(</td>
          <td class="paramtype">lbl_pt&#160;</td>
          <td class="paramname"><em>lbl</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">Routine *&#160;</td>
          <td class="paramname"><em>routine</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Creates and tears down the activation record of a procedure. </p>
<p>parameters are added to the stack in reverse order with the i_parm instruction. Formal parameters are read off the stack simply by their position: BP+machine_state+parameter_number</p>
<p>parameters must be contiguously packed at the top of the stack when i_call is made. this means we can't add new auto variables once a parameter has been pushed. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
